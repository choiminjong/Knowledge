<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GraphRAG 실시간 시각화 데모</title>
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #F5C842;
  height: 100vh;
  overflow: hidden;
}
.container {
  display: flex;
  height: 100vh;
  padding: 20px;
  gap: 20px;
}
.left-panel {
  flex: 0 0 420px;
  background: white;
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}
.right-panel {
  flex: 1;
  background: white;
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
}
h1 { font-size: 24px; color: #D97706; margin-bottom: 10px; }
.subtitle { font-size: 14px; color: #666; margin-bottom: 20px; }
.input-group { margin-bottom: 15px; }
label { display: block; font-size: 14px; font-weight: 600; color: #555; margin-bottom: 8px; }
textarea {
  width: 100%; padding: 12px; border: 2px solid #e0e0e0;
  border-radius: 8px; font-size: 14px; font-family: inherit;
  resize: vertical; transition: border-color 0.3s;
}
textarea:focus { outline: none; border-color: #D97706; }
.input-row {
  display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;
}
.topk-group { flex: 0 0 110px; margin-bottom: 0; }
.topk-group select {
  width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;
  font-size: 14px; font-family: inherit; background: white;
  cursor: pointer; transition: border-color 0.3s;
}
.topk-group select:focus { outline: none; border-color: #D97706; }
.mode-toggle {
  display: flex; margin-bottom: 15px; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden;
}
.mode-btn {
  flex: 1; padding: 10px; text-align: center; font-size: 13px; font-weight: 600;
  cursor: pointer; background: #f8f9fa; color: #666; transition: all 0.2s; border: none;
}
.mode-btn.active { background: #D97706; color: white; }
.mode-btn:hover:not(.active) { background: #FEF3C7; }
button {
  flex: 1; padding: 14px; background: #D97706; color: white;
  border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
  cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
}
button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(217,119,6,0.4); background: #B45309; }
button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
.answer-section { margin-top: 20px; overflow-y: auto; }
.answer-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #D97706; }
.answer-label { font-weight: 600; color: #D97706; margin-bottom: 8px; font-size: 14px; }
.answer-content { color: #333; line-height: 1.8; font-size: 14px; }
.answer-content a { color: #D97706; text-decoration: none; border-bottom: 1px solid #D97706; }
.answer-content strong { font-weight: 600; color: #555; }
.answer-content ul, .answer-content ol { margin-left: 20px; margin-bottom: 12px; }
.answer-content li { margin-bottom: 4px; }
.answer-content p { margin-bottom: 12px; }
.info-box { background: #FEF3C7; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 12px; color: #92400E; line-height: 1.8; }
.cypher-box {
  background: #1e1e2e; color: #a6e3a1; padding: 12px 14px; border-radius: 6px;
  margin-top: 10px; font-size: 12px; font-family: 'Consolas', 'Courier New', monospace;
  white-space: pre-wrap; word-break: break-all; max-height: 120px; overflow-y: auto;
  border-left: 4px solid #89b4fa;
}
.graph-container {
  flex: 1; border: 2px solid #e0e0e0; border-radius: 8px;
  background: #fafafa; position: relative; overflow: hidden;
}
#mynetwork { width: 100%; height: 100%; }
.loading {
  display: none; position: absolute; top: 50%; left: 50%;
  transform: translate(-50%,-50%); background: rgba(255,255,255,0.95);
  padding: 20px 40px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000;
}
.loading.active { display: block; }
.spinner {
  border: 4px solid #f3f3f3; border-top: 4px solid #D97706;
  border-radius: 50%; width: 40px; height: 40px;
  animation: spin 1s linear infinite; margin: 0 auto 10px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.legend {
  position: absolute; bottom: 15px; right: 15px;
  background: rgba(255,255,255,0.95); padding: 10px 20px;
  border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  font-size: 11px; z-index: 100; display: flex; align-items: center;
  gap: 15px; flex-wrap: wrap;
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-color { width: 16px; height: 16px; border-radius: 3px; }
.node-info-panel {
  position: absolute; bottom: 15px; left: 15px;
  background: rgba(255,255,255,0.98); padding: 20px; border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-size: 13px; z-index: 100;
  max-width: 400px; max-height: 300px; overflow-y: auto; display: none;
}
.node-info-panel.active { display: block; }
.node-info-title { font-weight: 700; font-size: 15px; color: #333; margin-bottom: 12px; border-bottom: 2px solid #D97706; padding-bottom: 8px; }
.node-info-item { margin-bottom: 8px; line-height: 1.5; }
.node-info-key { font-weight: 600; color: #555; display: inline-block; min-width: 100px; }
.node-info-value { color: #333; word-break: break-word; }
.close-panel { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 20px; color: #999; }
.close-panel:hover { color: #333; }
.example-queries { margin-top: 15px; padding: 12px; background: #f0f4ff; border-radius: 8px; }
.example-queries.hidden { opacity: 0; max-height: 0; padding: 0; margin: 0; overflow: hidden; }
.example-queries h3 { font-size: 13px; color: #D97706; margin-bottom: 8px; }
.example-query { font-size: 12px; color: #555; padding: 6px; cursor: pointer; border-radius: 4px; }
.example-query:hover { background: #FEF3C7; }
</style>
</head>
<body>
<div class="container">
  <div class="left-panel">
    <h1>GraphRAG Demo</h1>
    <div class="subtitle">Neo4j 뉴스 기사 기반 AI 검색 (Ollama 로컬)</div>

    <div class="mode-toggle">
      <button class="mode-btn active" id="modeSummary" onclick="setMode('summary')">요약 브리핑</button>
      <button class="mode-btn" id="modeList" onclick="setMode('list')">기사 목록</button>
    </div>
    <div class="input-group">
      <label>질문</label>
      <textarea id="question" rows="3" placeholder="뉴스 기사에 대해 질문하세요..."></textarea>
    </div>
    <div class="input-row">
      <div class="input-group topk-group">
        <label>답변 개수 (k)</label>
        <select id="topK">
          <option value="1">1개</option>
          <option value="3" selected>3개</option>
          <option value="5">5개</option>
          <option value="10">10개</option>
        </select>
      </div>
      <button id="askButton" onclick="askQuestion()">검색하기</button>
    </div>

    <div class="example-queries" id="exampleQueries">
      <h3>예시 질문</h3>
      <div class="example-query" onclick="setQuestion('정치 카테고리의 최신 뉴스 알려줘')">정치 카테고리의 최신 뉴스 알려줘</div>
      <div class="example-query" onclick="setQuestion('삼성전자 관련 기사 찾아줘')">삼성전자 관련 기사 찾아줘</div>
      <div class="example-query" onclick="setQuestion('카테고리별 기사 개수')">카테고리별 기사 개수</div>
      <div class="example-query" onclick="setQuestion('트럼프 대통령 관련 뉴스')">트럼프 대통령 관련 뉴스</div>
      <div class="example-query" onclick="setQuestion('언론사별 기사 개수')">언론사별 기사 개수</div>
    </div>

    <div class="answer-section">
      <div class="answer-box" id="answerBox" style="display:none">
        <div class="answer-label">답변</div>
        <div class="answer-content" id="answer"></div>
        <div class="info-box" id="infoBox"></div>
        <div class="cypher-box" id="cypherBox" style="display:none"></div>
      </div>
    </div>
  </div>

  <div class="right-panel">
    <div class="graph-container">
      <div id="mynetwork"></div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>검색 중...</div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:#97C2FC"></div>Article</div>
        <div class="legend-item"><div class="legend-color" style="background:#FFAB91"></div>Category</div>
        <div class="legend-item"><div class="legend-color" style="background:#A5D6A7"></div>Content</div>
        <div class="legend-item"><div class="legend-color" style="background:#CE93D8"></div>Media</div>
        <div class="legend-item"><div class="legend-color" style="background:#FFE082"></div>Author</div>
      </div>
      <div class="node-info-panel" id="nodeInfoPanel">
        <span class="close-panel" onclick="closeNodeInfo()">×</span>
        <div class="node-info-title" id="nodeInfoTitle">노드 정보</div>
        <div id="nodeInfoContent"></div>
      </div>
    </div>
  </div>
</div>

<script>
let network, nodes, edges;
let allNodesData = [], allEdgesData = [];
let currentMode = 'summary';

function setMode(mode) {
  currentMode = mode;
  document.getElementById('modeSummary').classList.toggle('active', mode === 'summary');
  document.getElementById('modeList').classList.toggle('active', mode === 'list');
}

window.onload = async function() { await initGraph(); };

async function initGraph() {
  try {
    const resp = await fetch('/graph');
    const data = await resp.json();
    allNodesData = data.nodes;
    allEdgesData = data.edges;

    const nodesArr = allNodesData.map(n => ({
      id: n.id,
      label: n.title.substring(0, 25) + (n.title.length > 25 ? '...' : ''),
      title: `${n.label}: ${n.title}`,
      color: { background: '#E0E0E0', border: '#BDBDBD' },
      font: { size: 12, color: '#757575' },
      shape: 'dot', size: 15
    }));
    const edgesArr = allEdgesData.map(e => ({
      id: e.id, from: e.source, to: e.target, label: '',
      arrows: 'to', color: { color: '#E0E0E0', highlight: '#FF6B6B' },
      width: 1, font: { size: 9, color: '#999' }
    }));

    nodes = new vis.DataSet(nodesArr);
    edges = new vis.DataSet(edgesArr);

    network = new vis.Network(document.getElementById('mynetwork'),
      { nodes, edges },
      {
        physics: {
          enabled: true,
          barnesHut: { gravitationalConstant: -8000, springConstant: 0.04, springLength: 95 },
          stabilization: { iterations: 200 }
        },
        interaction: { hover: true, tooltipDelay: 100 },
        nodes: { borderWidth: 2, shadow: true },
        edges: { width: 2, shadow: true, smooth: { type: 'continuous' } }
      }
    );
    network.on('click', function(p) {
      if (p.nodes.length > 0) showNodeInfo(p.nodes[0]);
      else closeNodeInfo();
    });
  } catch (err) {
    console.error('Graph init failed:', err);
  }
}

function getNodeColor(label) {
  return { Article: '#97C2FC', Category: '#FFAB91', Content: '#A5D6A7', Media: '#CE93D8', Author: '#FFE082' }[label] || '#DDD';
}

function setQuestion(q) { document.getElementById('question').value = q; }

async function askQuestion() {
  const question = document.getElementById('question').value.trim();
  if (!question) return;

  document.getElementById('exampleQueries').classList.add('hidden');
  document.getElementById('askButton').disabled = true;
  document.getElementById('loading').classList.add('active');
  document.getElementById('answerBox').style.display = 'none';
  resetGraph();

  try {
    const topK = parseInt(document.getElementById('topK').value);
    const resp = await fetch('/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, top_k: topK, mode: currentMode })
    });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();

    document.getElementById('answer').innerHTML = marked.parse(data.answer);

    const modeLabel = currentMode === 'summary' ? '요약 브리핑' : '기사 목록';
    let infoHtml = `모드: <b>${modeLabel}</b> &nbsp;|&nbsp; Retriever: <b>${data.retriever_used}</b> &nbsp;|&nbsp; 답변 수: <b>${topK}개</b>`;
    if (data.elapsed_sec !== undefined) {
      const sec = data.elapsed_sec;
      const display = sec >= 60
        ? `${Math.floor(sec / 60)}분 ${(sec % 60).toFixed(1)}초`
        : `${sec.toFixed(1)}초`;
      infoHtml += `<br>소요시간: <b>${display}</b>`;
    }
    document.getElementById('infoBox').innerHTML = infoHtml;

    const cypherBox = document.getElementById('cypherBox');
    if (data.cypher_query) {
      cypherBox.textContent = data.cypher_query;
      cypherBox.style.display = 'block';
    } else {
      cypherBox.style.display = 'none';
    }

    document.getElementById('answerBox').style.display = 'block';
    highlightSubgraph(data.used_nodes, data.used_edges);
  } catch (err) {
    alert('검색 실패: ' + err.message);
  } finally {
    document.getElementById('askButton').disabled = false;
    document.getElementById('loading').classList.remove('active');
  }
}

function resetGraph() {
  if (!nodes || !edges) return;
  nodes.get().forEach(n => nodes.update({
    id: n.id, color: { background: '#E0E0E0', border: '#BDBDBD' },
    borderWidth: 2, size: 15, font: { size: 12, color: '#757575' }
  }));
  edges.get().forEach(e => edges.update({
    id: e.id, color: { color: '#E0E0E0' }, width: 1, label: ''
  }));
}

function findConnected(nodeIds, relType, direction) {
  const result = [];
  allEdgesData.forEach(e => {
    if (e.relationship !== relType) return;
    if (direction === 'out' && nodeIds.includes(e.source)) result.push(e.target);
    if (direction === 'in' && nodeIds.includes(e.target)) result.push(e.source);
    if (direction === 'both') {
      if (nodeIds.includes(e.source)) result.push(e.target);
      if (nodeIds.includes(e.target)) result.push(e.source);
    }
  });
  return [...new Set(result)];
}

function highlightSubgraph(nodeIds, edgeIds) {
  if (!nodes || !edges) return;
  const matched = [];

  nodeIds.forEach(sid => {
    allNodesData.forEach(nd => {
      const parts = sid.split('_');
      const label = parts[0];
      const val = parts.slice(1).join('_');
      if (nd.label !== label) return;
      const p = nd.properties;
      if (
        (label === 'Article' && p.article_id === val) ||
        (label === 'Category' && p.name === val) ||
        (label === 'Content' && p.content_id === val) ||
        (label === 'Media' && p.name === val) ||
        (label === 'Author' && p.name === val)
      ) matched.push(nd.id);
    });
  });

  if (edgeIds.includes('HAS_CHUNK')) {
    const contentIds = matched.filter(id => allNodesData.find(n => n.id === id)?.label === 'Content');
    findConnected(contentIds, 'HAS_CHUNK', 'both').forEach(id => { if (!matched.includes(id)) matched.push(id); });
  }
  if (edgeIds.includes('BELONGS_TO')) {
    const artIds = matched.filter(id => allNodesData.find(n => n.id === id)?.label === 'Article');
    findConnected(artIds, 'BELONGS_TO', 'both').forEach(id => { if (!matched.includes(id)) matched.push(id); });
  }

  matched.forEach(id => {
    const nd = allNodesData.find(n => n.id === id);
    nodes.update({
      id, color: { background: getNodeColor(nd?.label), border: '#C92A2A' },
      borderWidth: 4, size: 25, font: { size: 14, color: '#000' }
    });
  });

  if (matched.length > 0) {
    edges.get().forEach(e => {
      const ed = allEdgesData.find(x => x.id === e.id);
      if (ed && matched.includes(ed.source) && matched.includes(ed.target)) {
        edges.update({ id: e.id, color: { color: '#FF6B6B' }, width: 3, label: ed.relationship });
      }
    });
    network.fit({ nodes: matched, animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
  }
}

function showNodeInfo(nodeId) {
  const nd = allNodesData.find(n => n.id === nodeId);
  if (!nd) return;
  document.getElementById('nodeInfoTitle').innerHTML = `${nd.label}: ${nd.title}`;
  let html = '';
  if (nd.properties) {
    for (const [k, v] of Object.entries(nd.properties)) {
      if (!v || v === '' || k === 'embedding') continue;
      let dv = v;
      if (k === 'url' && typeof v === 'string' && v.startsWith('http'))
        dv = `<a href="${v}" target="_blank">${v}</a>`;
      else if (typeof v === 'string' && v.length > 150)
        dv = v.substring(0, 150) + '...';
      html += `<div class="node-info-item"><span class="node-info-key">${k}:</span> <span class="node-info-value">${dv}</span></div>`;
    }
  }
  document.getElementById('nodeInfoContent').innerHTML = html || '<div>속성 없음</div>';
  document.getElementById('nodeInfoPanel').classList.add('active');
}

function closeNodeInfo() { document.getElementById('nodeInfoPanel').classList.remove('active'); }
</script>
</body>
</html>
